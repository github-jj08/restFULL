<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bit.project.restfull.mapper.AdminBoardMapper">
	
	<!-- 메인 게시판/게시글 기능 -->
	<resultMap id="AttachmentVO" type="bit.project.restfull.vo.AttachmentVO" >
		<id property="board_numbers" column="board_numbers"/>
		<result property="filename" column="filename"/>
		<result property="filedirectory" column="filedirectory"/>
		<result property="filesize" column="filesize"/>
	</resultMap>
	
	<resultMap id="BoardContents" type="bit.project.restfull.vo.AdminBoardVO">
		<id property="board_numbers" column="board_numbers"/>	
		<result property="title" column="title"/>
		<result property="contents" column="contents"/>
		<result property="hit" column="hit"/>
		<result property="dates" column="dates"/>
		<result property="member_id" column="member_id"/>
		<result property="boardlist_numbers" column="boardlist_numbers"/>
		<!-- name 컬럼명은 boardlist 테이블에 있는 name -->
		<result property="boardlistName" column="name"/>
		<result property="thumbnail" column="thumbnail"/>
		<collection property="attachmentVO" javaType="bit.project.restfull.vo.AttachmentVO" resultMap="AttachmentVO"></collection>
	</resultMap>

	<!-- 메인 게시글 게시판 그룹 번호가 1이라고 했을때, 검색어를 기준으로 메인 게시글 전체를 불러오는 쿼리 -->
  	<select id="getList" resultMap="BoardContents">
	<![CDATA[
		select b.*, l.*, a.* from board b, boardlist l, attachment a
			where b.board_numbers = a.board_numbers
				and b.boardlist_numbers = l.boardlist_numbers
                and l.boardlist_numbers = #{boardlist_numbers}
	]]>
	</select>
	
	<resultMap id="BoardVO" type="bit.project.restfull.vo.BoardVO">
		<id property="board_numbers" column="board_numbers"/>	
		<result property="title" column="title"/>
		<result property="contents" column="contents"/>
		<result property="hit" column="hit"/>
		<result property="dates" column="dates"/>
		<result property="member_id" column="member_id"/>
		<result property="boardlist_numbers" column="boardlist_numbers"/>
		<result property="boardName" column="boardName"/>
		<result property="filter_numbers" column="filter_numbers"/>
		<!-- name 컬럼명은 boardlist 테이블에 있는 name -->
		<result property="filterName" column="filterName"/>
		<result property="thumbnail" column="thumbnail"/>
	</resultMap>
	
	<!-- 필터가 있을 경우 다음의 getList를 호출 -->
  	<select id="getFilterList" resultMap="BoardVO">
	<![CDATA[
		select b.*,
		l.boardlist_numbers as boardlist_numbers,
		l.name as boardName,
		f.filter_numbers as filter_numbers,
		f.name as filterName
		from board b, boardlist l, filter f
			where b.boardlist_numbers = l.boardlist_numbers
                and b.filter_numbers = f.filter_numbers
                and l.boardlist_numbers = #{boardlist_numbers}
	]]>
	</select>
	
	<!-- 메인 게시글 출력 -->
 	<select id="getBoardVO" resultType="bit.project.restfull.vo.AdminBoardVO">
	<![CDATA[
		select * from board where board_numbers = #{board_numbers} 
	]]>
	</select>
	
	<!-- 메인 게시글의 첨부파일 출력 -->
	<select id="getBoardAttachmentVO" resultType="bit.project.restfull.vo.AttachmentVO">
	<![CDATA[
		select a.* from board b, attachment a
			where b.board_numbers = a.board_numbers
				and b.board_numbers = #{board_numbers} 
	]]>
	</select>

	<!-- 게시글 작성 -->	
	<insert id="insertBoardVO" parameterType="bit.project.restfull.vo.AdminBoardVO">
	<![CDATA[
		INSERT INTO BOARD (board_numbers, TITLE, CONTENTS, HIT, DATES, MEMBER_ID,BOARDLIST_NUMBERS) VALUES (BOARD_SEQ.NEXTVAL, #{title}, #{contents}, 0, sysdate, #{member_id},#{boardlist_numbers})
	]]>
	</insert>
	
	<!-- 게시글 썸네일 삽입 -->	
	<update id="updateBoardThumbImg">
	<![CDATA[
		update board set thumbnail=#{thumbnail} where board_numbers = #{board_numbers}
	]]>
	</update>
	
	<!-- 게시글의 첨부파일 작성 -->
	<insert id="insertAttachmentVO" parameterType="bit.project.restfull.vo.AttachmentVO">
	<selectKey keyProperty="board_numbers" order="BEFORE" resultType="int">
		SELECT BOARD_SEQ.CURRVAL AS board_numbers FROM DUAL
	</selectKey>
	<![CDATA[
		insert into ATTACHMENT (FILENAME, board_numbers, FILEDIRECTORY,FILESIZE) values (#{fileName}, #{board_numbers}, #{fileDirectory},#{fileSize})
	]]>
	</insert>
	
	<!-- 게시글 수정 : 글내용 수정 -->
	<update id="updateBoardVO">
		update board set title = #{title}, contents = #{contents} where board_numbers = #{board_numbers}
	</update>
	
	<!-- 게시글 삭제 - attachment테이블에서 board_numbers에 대한 종속 삭제 기능 설정해둬서 첨부파일이 자동으로 삭제됨 -->
	<delete id="deleteBoardVO">
	<![CDATA[
		delete from board where board_numbers = #{board_numbers}
	]]>
	</delete>
	
	<!-- 게시글 조회수 올리기 -->
	<update id="upHit">
	<![CDATA[
		update board set hit = hit + 1 where board_numbers = #{board_numbers}
	]]>
	</update>
	
	
	<!-- 지역번호 목록 (가나다순) -->
	<select id="sigunguList" resultType="bit.project.restfull.vo.SidoguVO">
	<![CDATA[
		select * from sidogu where sidocode = #{sidocode} order by sidocode asc
	]]>
	</select>
	
	<!-- 여행지 목록 -->
	<resultMap id="SidoguVO" type="bit.project.restfull.vo.SidoguVO" >
		<id property="sigungu_code" column="sigungu_code"/>
		<result property="sigunguname" column="sigunguname"/>
		<result property="sidocode" column="sidocode"/>
		<result property="sidoname" column="sidoname"/>
	</resultMap>
	
	<resultMap id="DestinationContents" type="bit.project.restfull.vo.DestinationVO">
		<id property="destination_name" column="destination_name"/>	
		<result property="jibunaddress" column="jibunaddress"/>
		<result property="doroaddress" column="doroaddress"/>
		<result property="details" column="details"/>
		<result property="lat" column="lat"/>
		<result property="lng" column="lng"/>
		<result property="sigungu_code" column="sigungu_code"/>
		<result property="filter_numbers" column="filter_numbers"/>
		<result property="location" column="location"/>
		<association property="sidoguVO" javaType="bit.project.restfull.vo.SidoguVO" resultMap="SidoguVO"></association>
	</resultMap>
	
	<select id="getDestList" resultMap="DestinationContents">
	<![CDATA[
		select * from destination d, sidogu s
		where d.sigungu_code = s.sigungu_code 
		order by s.sidocode asc, s.sigunguname asc, d.destination_name asc
	]]>
	</select>
	
	<!-- 여행지 등록 -->
	<insert id="insertDestVO" parameterType="bit.project.restfull.vo.DestinationVO">
	<![CDATA[
		INSERT INTO DESTINATION (destination_name, jibunaddress, doroaddress, details, lat, lng, sigungu_code) VALUES (#{destination_name}, #{jibunaddress}, #{doroaddress}, #{details}, #{lat}, #{lng}, #{sigungu_code})
	]]>
	</insert>

	<!-- 여행지 보기 -->
 	<select id="getDestVO" resultMap="DestinationContents">
	<![CDATA[
		select * from destination d, sidogu s where d.sigungu_code = s.sigungu_code and d.destination_name = #{destination_name} 
	]]>
	</select>

	<!-- 여행지 수정 -->
	<update id="updateDestVO">
		update DESTINATION set jibunaddress = #{jibunaddress}, doroaddress = #{doroaddress}, details = #{details}, lat = #{lat}, lng = #{lng}, sigungu_code = #{sigungu_code} where destination_name = #{destination_name}
	</update> 
	
	<!-- 여행지 삭제 -->
	<delete id="deleteDestVO">
	<![CDATA[
		delete from DESTINATION where destination_name = #{destination_name}
	]]>
	</delete>
	
	<!-- 상품 목록 -->
	<select id="getGoodsList" resultType="bit.project.restfull.vo.GoodsVO">
	<![CDATA[
		select * from goods where destination_name = #{destination_name} 
	]]>
	</select>
	
	<!-- 상품 등록 -->
	<insert id="insertGoodsVO" parameterType="bit.project.restfull.vo.GoodsVO">
	<![CDATA[
		insert INTO goods (GOODS_NUMBERS,DESTINATION_NAME,NAME,PRICE,AMOUNT,STATUS,SELLSTART,SELLEND,SELLER) 
			VALUES (goods_seq.nextval,#{destination_name}, #{name}, #{price},#{amount},#{status},#{sellstart},#{sellend},#{seller})
	]]>
	</insert>

	<!-- 상품 보기 -->
 	<select id="getGoodsVO" resultType="bit.project.restfull.vo.GoodsVO">
	<![CDATA[
		select * from goods where GOODS_NUMBERS = #{goods_numbers} 
	]]>
	</select>

	<!-- 상품 수정 -->
	<update id="updateGoodsVO">
	<![CDATA[
		update goods set 
		DESTINATION_NAME=#{destination_name},NAME=#{name},PRICE=#{price},AMOUNT=#{amount},STATUS=#{status},SELLSTART=#{sellstart},SELLEND=#{sellend},SELLER=#{seller} 
		where GOODS_NUMBERS = #{goods_numbers} 
	]]>
	</update> 
	
	<!-- 상품 삭제 -->
	<delete id="deleteGoodsVO">
	<![CDATA[
		delete from goods where GOODS_NUMBERS = #{goods_numbers}
	]]>
	</delete>
	
	<!-- 시군구 코드 - 여행지 목록 -->
	<select id="getDests" parameterType="int" resultType="bit.project.restfull.vo.DestinationVO">
	<![CDATA[
		select * from destination where sigungu_code = #{sigungu_code}
	]]>
	</select>
	
	<!-- 여행코스 관련 상품 목록 -->
	<select id="getRGoods"  resultType="bit.project.restfull.vo.GoodsVO">
	<![CDATA[
		select * from goods where destination_name in
	]]>
		<foreach collection="array" item="item" open="(" close=")" separator=",">
		 #{item}
		</foreach>
	</select>
	
	<!-- 특정상품 번호에 해당하는 구매예정 상품 목록 -->
	<select id="myGoods"  resultType="bit.project.restfull.vo.GoodsVO">
	<![CDATA[
		select * from goods where goods_numbers in
	]]>
		<foreach collection="array" item="item" open="(" close=")" separator=",">
		 #{item}
		</foreach>
	</select>
	
	<!-- 주문 정보 등록 -->
	<insert id="insertRequest" parameterType="java.util.List" > 
		<foreach item="item" index="index" collection="list" separator=" " open="INSERT ALL " close="SELECT * FROM DUAL">
			into request 
			(
				REQUEST_NUMBERS,
				DATES,
				IMP_UID,
				MEMBER_ID,
				GOODS_NUMBERS,
				DESTINATION_NAME,
				CANCEL,
				MERCHANT_UID
			) values
			(
				#{item.request_numbers} ,
				sysdate, 
				#{item.imp_uid, jdbcType=VARCHAR} , 
				#{item.member_id} , 
				#{item.goods_numbers},
				#{item.destination_name},
				#{item.cancel},
				#{item.merchant_uid}
			) 
		</foreach>
	</insert>


	<resultMap id="RequestVO" type="bit.project.restfull.vo.RequestVO">
		<id property="request_numbers" column="request_numbers"/>	
		<result property="dates" column="dates"/>
		<result property="imp_uid" column="imp_uid"/>
		<result property="member_id" column="member_id"/>
		<result property="goods_numbers" column="goods_numbers"/>
		<result property="destination_name" column="destination_name"/>
		<result property="cancel" column="cancel"/>
		<result property="price" column="price"/>
		<result property="merchant_uid" column="merchant_uid"/>
		<result property="productName" column="productName"/>
	</resultMap>
	
	<!-- 주문정보 가져오기 -->
 	<select id="getRequests" resultMap="RequestVO">
	<![CDATA[
		select  r.*, g.price as price, g.name as productName from  request r, goods g 
		where r.goods_numbers = g.goods_numbers
		and r.merchant_uid = #{merchant_uid}
	]]>
	</select>

	
	<update id="updateRequests">
	<![CDATA[
		update request set imp_uid = #{imp_uid} where merchant_uid =#{merchant_uid}
	]]>
	</update> 

	<!-- 여행코스 등록 -->
	<insert id="insertTravelCourse" parameterType="java.util.List" > 
		<foreach item="item" index="index" collection="list" separator=" " open="INSERT ALL " close="SELECT * FROM DUAL">
			into TRAVEL 
			(
				TRAVEL_NUMBERS,
				MEMBER_ID,
				CONTENTS,
				TCALIAS,
				DATES,
				TCUNIQUENUM
			) values
			(
				travel_seq.nextval,
				#{item.member_id},
				#{item.contents},
				#{item.tcAlias},
				sysdate,
				#{item.tcUiqueNum}
			) 
		</foreach>
	</insert>
	

</mapper>
